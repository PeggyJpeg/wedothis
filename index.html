<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AppLovin Corporation (APP) - Investment Report</title>
  <style>
    :root {
      --primary-color: #1a56db;
      --secondary-color: #17a2b8;
      --text-color: #333;
      --light-bg: #f8f9fa;
      --border-color: #dee2e6;
      --error-color: #dc3545;
      --placeholder-color: #6c757d;
      --success-color: #28a745;
      --box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    }
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 0;
      background-color: var(--light-bg);
      color: var(--text-color);
    }
    .container {
      max-width: 950px;
      margin: 20px auto;
      background-color: #ffffff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: var(--box-shadow);
    }
    h1,
    h2,
    h3 {
      color: var(--primary-color);
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 8px;
      margin-top: 25px;
      margin-bottom: 15px;
    }
    h1 {
      text-align: center;
      font-size: 2em;
      border-bottom: 2px solid var(--primary-color);
      margin-bottom: 30px;
      padding-bottom: 10px;
    }
    h2 {
      font-size: 1.5em;
      margin-top: 30px;
    }
    h3 {
      font-size: 1.2em;
      border-bottom: none;
      color: var(--secondary-color);
      margin-top: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-size: 0.95em;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    th,
    td {
      border: 1px solid var(--border-color);
      padding: 12px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background-color: #e9ecef;
      font-weight: 600;
      color: #495057;
    }
    tr:nth-child(even) {
      background-color: var(--light-bg);
    }
    tr:hover {
      background-color: rgba(0, 86, 179, 0.03);
    }
    ul {
      margin-left: 20px;
      padding-left: 0;
      list-style-type: disc;
    }
    li {
      margin-bottom: 10px;
    }
    code {
      font-family: Consolas, Monaco, "Andale Mono", "Ubuntu Mono", monospace;
      background-color: #e9ecef;
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 0.9em;
    }
    .metric-label {
      font-weight: bold;
      min-width: 200px;
      display: inline-block;
    }
    .metric-value {
      display: inline-block;
      font-weight: 500;
    }
    .data-placeholder {
      color: var(--placeholder-color);
      font-style: italic;
    }
    .error-message {
      color: var(--error-color);
      font-style: italic;
    }
    .success-message {
      color: var(--success-color);
    }
    .section-intro {
      margin-bottom: 18px;
      font-style: italic;
      color: #555;
      line-height: 1.5;
    }
    .data-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .data-grid-item {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      border-left: 3px solid var(--primary-color);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    .data-grid-item h4 {
      margin-top: 0;
      margin-bottom: 10px;
      color: var(--primary-color);
    }
    .header-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }
    .header-logo img {
      height: 40px;
      margin-right: 15px;
      border-radius: 5px;
    }
    @media (max-width: 768px) {
      .container {
        padding: 20px;
        margin: 10px;
        border-radius: 5px;
      }
      .metric-label {
        min-width: 140px;
      }
      .data-grid {
        grid-template-columns: 1fr;
      }
    }
    .loading-spinner {
      display: inline-block;
      width: 15px;
      height: 15px;
      border: 2px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
      margin-left: 5px;
      vertical-align: middle;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-logo">
      <img
        src="https://logo.clearbit.com/applovin.com"
        alt="AppLovin Logo"
        onerror="this.onerror=null; this.src=''; this.style.display='none';"
      />
      <h1>AppLovin Corporation (NASDAQ: APP) - Investment Report</h1>
    </div>

    <h2>1. Executive Summary</h2>
    <p>
      AppLovin Corporation operates a leading marketing software platform that
      provides mobile app developers with tools for growth, user acquisition,
      monetization, and measurementâ€”powered by its proprietary machine learning
      engine (AXON). The company primarily serves the mobile gaming industry
      while expanding into additional verticals. After shifting focus from
      first-party game development to high-margin software platforms, AppLovin
      has shown strong revenue and margin growth.
    </p>

    <h2>2. Company Overview</h2>
    <p class="section-intro">
      A closer look at AppLovin's business model, technology, and market position.
    </p>
    <div class="data-grid">
      <div class="data-grid-item">
        <h4>Business Model</h4>
        <p>
          AppLovin offers an integrated technology stack for mobile app developers
          to market, monetize, analyze, and publish their apps. It runs two main
          segments:
        </p>
        <ul>
          <li>
            <strong>Software Platform:</strong> High-margin products including
            AppDiscovery, MAX mediation, and Adjust for attribution.
          </li>
          <li>
            <strong>Apps (Legacy):</strong> Previously operated its own gaming
            content, now de-emphasized.
          </li>
        </ul>
      </div>
      <div class="data-grid-item">
        <h4>Technology & Differentiation</h4>
        <p>
          The AXON machine learning engine powers advanced audience targeting,
          automated media spend allocation, and real-time performance
          optimization.
        </p>
      </div>
      <div class="data-grid-item">
        <h4>Market Position</h4>
        <p>
          Operating in the mobile advertising and app monetization space, AppLovin
          holds a strong position in mobile gaming and is expanding into other
          verticals.
        </p>
      </div>
    </div>

    <h2>3. Historical Financial Performance</h2>
    <p class="section-intro">
      Review of key historical financial trends.
    </p>
    <table>
      <thead>
        <tr>
          <th>Fiscal Year / Period</th>
          <th>Revenue (USD Millions)</th>
          <th>Adj. EBITDA (USD Millions)</th>
          <th>Net Income/(Loss) (USD Millions)</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>2020</td>
          <td>$1,451</td>
          <td>$406</td>
          <td>($126)</td>
          <td>Pre-IPO, rapid growth phase</td>
        </tr>
        <tr>
          <td>2021</td>
          <td>$2,790</td>
          <td>$742</td>
          <td>($47)</td>
          <td>IPO year; MoPub acquisition announced</td>
        </tr>
        <tr>
          <td>2022</td>
          <td>$2,821</td>
          <td>$866</td>
          <td>($228)</td>
          <td>Strategic pivot amid a challenging ad market</td>
        </tr>
        <tr>
          <td>2023</td>
          <td>$3,373</td>
          <td>$1,583</td>
          <td>$361</td>
          <td>Strong software growth and margin expansion</td>
        </tr>
        <tr>
          <td>Q1 2024</td>
          <td>$1,016</td>
          <td>$561</td>
          <td>$156</td>
          <td>Continued momentum and increased AXON adoption</td>
        </tr>
      </tbody>
    </table>

    <h2>4. Valuation Metrics (Live Data)</h2>
    <p class="section-intro">
      Real-time market and financial metrics.
    </p>
    <div class="data-grid">
      <div class="data-grid-item">
        <h4>Market Metrics</h4>
        <ul>
          <li>
            <span class="metric-label">Share Price:</span>
            <span class="metric-value data-placeholder" id="current-price">
              Loading...
              <span class="loading-spinner"></span>
            </span>
          </li>
          <li>
            <span class="metric-label">Market Capitalization:</span>
            <span class="metric-value data-placeholder" id="market-cap">
              Loading...
              <span class="loading-spinner"></span>
            </span>
          </li>
          <li>
            <span class="metric-label">Enterprise Value (EV):</span>
            <span class="metric-value data-placeholder" id="enterprise-value">
              Calculating...
              <span class="loading-spinner"></span>
            </span>
          </li>
          <li>
            <span class="metric-label">52-Week Range:</span>
            <span class="metric-value data-placeholder" id="52wk-range">
              Loading...
              <span class="loading-spinner"></span>
            </span>
          </li>
        </ul>
      </div>
      <div class="data-grid-item">
        <h4>Financial Metrics</h4>
        <ul>
          <li>
            <span class="metric-label">Latest Annual Revenue:</span>
            <span class="metric-value data-placeholder" id="latest-revenue">
              Loading...
              <span class="loading-spinner"></span>
            </span>
          </li>
          <li>
            <span class="metric-label">Latest Annual EBITDA:</span>
            <span class="metric-value data-placeholder" id="latest-ebitda">
              Loading...
              <span class="loading-spinner"></span>
            </span>
          </li>
          <li>
            <span class="metric-label">LTM EBITDA:</span>
            <span class="metric-value data-placeholder" id="ltm-ebitda">
              Loading...
              <span class="loading-spinner"></span>
            </span>
          </li>
          <li>
            <span class="metric-label">EPS (TTM):</span>
            <span class="metric-value data-placeholder" id="eps-ttm">
              Loading...
              <span class="loading-spinner"></span>
            </span>
          </li>
        </ul>
      </div>
      <div class="data-grid-item">
        <h4>Valuation Multiples</h4>
        <ul>
          <li>
            <span class="metric-label">EV / Revenue:</span>
            <span class="metric-value data-placeholder" id="ev-revenue-multiple">
              Calculating...
              <span class="loading-spinner"></span>
            </span>
          </li>
          <li>
            <span class="metric-label">EV / EBITDA:</span>
            <span class="metric-value data-placeholder" id="ev-ebitda-multiple">
              Calculating...
              <span class="loading-spinner"></span>
            </span>
          </li>
          <li>
            <span class="metric-label">P/E Ratio (TTM):</span>
            <span class="metric-value data-placeholder" id="pe-ratio">
              Calculating...
              <span class="loading-spinner"></span>
            </span>
          </li>
          <li>
            <span class="metric-label">PEG Ratio (Est):</span>
            <span class="metric-value data-placeholder" id="peg-ratio">
              Requires Analyst Data
            </span>
          </li>
        </ul>
      </div>
    </div>
    <p>
      <strong>Valuation Commentary:</strong>
      AppLovinâ€™s high-margin Software Platform, coupled with strong growth and margin expansion, is a key driver of the companyâ€™s valuation. These metrics should be compared with industry peers.
    </p>

    <h2>5. Investment Thesis & Valuation Range</h2>
    <p class="section-intro">
      Analysis of potential valuation ranges based on various methodologies.
    </p>
    <table>
      <thead>
        <tr>
          <th>Valuation Method</th>
          <th>Low End ($/Share)</th>
          <th>High End ($/Share)</th>
          <th>Commentary</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Comparable Companies</td>
          <td>$70</td>
          <td>$95</td>
          <td>Based on EV/Revenue and EV/EBITDA multiples</td>
        </tr>
        <tr>
          <td>Precedent Transactions</td>
          <td>$75</td>
          <td>$100</td>
          <td>Including control premium from M&A deals</td>
        </tr>
        <tr>
          <td>Discounted Cash Flow (DCF)</td>
          <td>$80</td>
          <td>$110</td>
          <td>Using WACC of 9â€“11% and terminal growth of 3â€“4%</td>
        </tr>
        <tr>
          <td>Analyst Price Targets</td>
          <td>$75</td>
          <td>$125</td>
          <td>Published Wall Street estimates (May 2024)</td>
        </tr>
        <tr>
          <td>52-Week Trading Range</td>
          <td class="data-placeholder" id="52wk-low">Loading...</td>
          <td class="data-placeholder" id="52wk-high">Loading...</td>
          <td>Live data</td>
        </tr>
        <tr>
          <td><strong>Current Share Price</strong></td>
          <td>
            <strong class="data-placeholder" id="current-price-ref">Loading...</strong>
          </td>
          <td></td>
          <td><em>(For reference)</em></td>
        </tr>
      </tbody>
    </table>

    <h2>6. Competitor Analysis</h2>
    <p class="section-intro">
      Comparison of AppLovin with key peers.
    </p>
    <table>
      <thead>
        <tr>
          <th>Competitor</th>
          <th>Primary Overlap</th>
          <th>Relative Strengths</th>
          <th>Relative Weaknesses</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Unity Software (U)</strong></td>
          <td>Ad monetization, user acquisition</td>
          <td>Game development ecosystem, engine ownership</td>
          <td>Less focused on pure ad optimization</td>
        </tr>
        <tr>
          <td><strong>Meta Platforms (META)</strong></td>
          <td>Mobile app advertising</td>
          <td>Large scale, data advantage</td>
          <td>Diversified business lines</td>
        </tr>
        <tr>
          <td><strong>Google (GOOGL)</strong></td>
          <td>Google Ads, AdMob</td>
          <td>Android ecosystem, search dominance</td>
          <td>Less gaming ad focus; regulatory challenges</td>
        </tr>
        <tr>
          <td><strong>Digital Turbine (APPS)</strong></td>
          <td>App distribution and ad tech</td>
          <td>Strong OEM/carrier relationships</td>
          <td>Smaller scale, less advanced AI</td>
        </tr>
        <tr>
          <td><strong>The Trade Desk (TTD)</strong></td>
          <td>Programmatic advertising</td>
          <td>Wide digital channel focus</td>
          <td>Different customer base</td>
        </tr>
      </tbody>
    </table>
    <h3>Competitive Advantages:</h3>
    <ul>
      <li><strong>Integrated Platform:</strong> Combines UA, monetization, and analytics.</li>
      <li><strong>AXON AI:</strong> Advanced machine learning capabilities.</li>
      <li><strong>Mobile Gaming Expertise:</strong> Deep domain knowledge in the largest mobile vertical.</li>
      <li><strong>Scale & Data:</strong> Significant data advantage driving optimization.</li>
      <li><strong>Neutral Mediation:</strong> The MAX platform is perceived as independent.</li>
    </ul>

    <h2>7. Debt & Balance Sheet Analysis (Live Data)</h2>
    <p class="section-intro">
      Evaluation of the current debt profile and liquidity.
    </p>
    <div class="data-grid">
      <div class="data-grid-item">
        <h4>Debt Profile</h4>
        <ul>
          <li>
            <span class="metric-label">Total Debt:</span>
            <span class="metric-value data-placeholder" id="total-debt">
              Loading...
              <span class="loading-spinner"></span>
            </span>
          </li>
          <li>
            <span class="metric-label">Cash & Equivalents:</span>
            <span class="metric-value data-placeholder" id="cash-equivalents">
              Loading...
              <span class="loading-spinner"></span>
            </span>
          </li>
          <li>
            <span class="metric-label">Net Debt:</span>
            <span class="metric-value data-placeholder" id="net-debt">
              Calculating...
              <span class="loading-spinner"></span>
            </span>
          </li>
          <li>
            <span class="metric-label">Debt Maturity:</span>
            <span class="metric-value">Term Loan due 2028, Notes due 2029</span>
          </li>
        </ul>
      </div>
      <div class="data-grid-item">
        <h4>Credit Metrics</h4>
        <ul>
          <li>
            <span class="metric-label">Net Debt / LTM EBITDA:</span>
            <span class="metric-value data-placeholder" id="leverage-ratio">
              Calculating...
              <span class="loading-spinner"></span>
            </span>
          </li>
          <li>
            <span class="metric-label">Interest Coverage Ratio:</span>
            <span class="metric-value data-placeholder" id="interest-coverage">
              Calculating...
              <span class="loading-spinner"></span>
            </span>
          </li>
          <li>
            <span class="metric-label">Current Ratio:</span>
            <span class="metric-value data-placeholder" id="current-ratio">
              Loading...
              <span class="loading-spinner"></span>
            </span>
          </li>
          <li>
            <span class="metric-label">Credit Rating:</span>
            <span class="metric-value">BB (S&P) / Ba2 (Moody's)</span>
          </li>
        </ul>
      </div>
      <div class="data-grid-item">
        <h4>Capital Allocation</h4>
        <ul>
          <li>
            <span class="metric-label">Share Repurchase Program:</span>
            <span class="metric-value">$1.5B authorized (2023â€“2024)</span>
          </li>
          <li>
            <span class="metric-label">Dividend Policy:</span>
            <span class="metric-value">No regular dividend</span>
          </li>
          <li>
            <span class="metric-label">Recent Debt Reduction:</span>
            <span class="metric-value">~$650M in 2023</span>
          </li>
          <li>
            <span class="metric-label">CapEx as % of Revenue:</span>
            <span class="metric-value">~2â€“3%</span>
          </li>
        </ul>
      </div>
    </div>
    <p>
      <strong>Balance Sheet Commentary:</strong> AppLovin has been deleveraging while using strong free cash flow to support share buybacks. Its current leverage appears manageable given the reported EBITDA.
    </p>

    <h2>8. Recent Developments & Growth Catalysts</h2>
    <p class="section-intro">
      Highlights of recent business developments and potential future drivers.
    </p>
    <h3>Recent Business Developments:</h3>
    <ul>
      <li>
        <strong>AXON 2.0 Rollout (Q1 2024):</strong> Enhanced ML capabilities leading to improved ad performance.
      </li>
      <li>
        <strong>Vertical & Geographic Expansion:</strong> Greater penetration into non-gaming markets and emerging regions.
      </li>
      <li>
        <strong>Strategic Partnerships:</strong> Broader collaborations with major publishers and ad networks.
      </li>
      <li>
        <strong>Executive Additions:</strong> New hires enhancing leadership in tech and finance.
      </li>
      <li>
        <strong>Share Repurchase Activity:</strong> Aggressive buybacks supporting EPS growth.
      </li>
    </ul>
    <h3>Growth Catalysts:</h3>
    <ul>
      <li>
        <strong>Continuous AI Enhancement:</strong> Ongoing improvements in the AXON engine.
      </li>
      <li>
        <strong>Vertical Expansion:</strong> New opportunities in sectors beyond gaming (e-commerce, fintech, etc.).
      </li>
      <li>
        <strong>Regulatory Adaptation:</strong> Strengthening its position as a privacy-compliant solution.
      </li>
      <li>
        <strong>Strategic Acquisitions:</strong> Potential add-on deals in the fragmented ad-tech space.
      </li>
    </ul>

    <h2>9. Management & Corporate Governance</h2>
    <p class="section-intro">
      Overview of the leadership, board composition, and strategic priorities.
    </p>
    <div class="data-grid">
      <div class="data-grid-item">
        <h4>Key Leadership</h4>
        <ul>
          <li><strong>Adam Foroughi</strong> â€“ Co-Founder & CEO</li>
          <li><strong>Herald Chen</strong> â€“ President & CFO</li>
          <li><strong>Katie Jansen</strong> â€“ Chief Marketing Officer</li>
          <li><strong>Victoria Valenzuela</strong> â€“ General Counsel</li>
          <li><strong>Andrew Karam</strong> â€“ Chief Technology Officer</li>
        </ul>
      </div>
      <div class="data-grid-item">
        <h4>Board Composition</h4>
        <ul>
          <li>9 directors (7 independent)</li>
          <li>Diverse expertise in tech, finance, and gaming</li>
          <li>Dual-class share structure with founder control</li>
          <li>Committees: Audit, Compensation, Nominating & Governance</li>
        </ul>
      </div>
      <div class="data-grid-item">
        <h4>Strategic Priorities</h4>
        <ul>
          <li>Grow the Software Platform and enhance AI capabilities</li>
          <li>Expand into verticals beyond gaming</li>
          <li>Adopt balanced capital allocation strategies</li>
          <li>Boost operational efficiency and margin expansion</li>
          <li>Innovate with privacy-focused solutions</li>
        </ul>
      </div>
    </div>
    <p>
      <strong>Management Effectiveness:</strong> The leadershipâ€™s focus on a high-margin software strategy has led to robust revenue growth and improved cash flow.
    </p>

    <h2>10. Risk Factors</h2>
    <p class="section-intro">
      A high-level overview of key risks facing the company.
    </p>
    <table>
      <thead>
        <tr>
          <th>Risk Category</th>
          <th>Specific Risks</th>
          <th>Potential Impact</th>
          <th>Mitigation</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Competitive</strong></td>
          <td>
            Intense competition from Unity, Meta, Google and new entrants
          </td>
          <td>
            Margin pressure and market share erosion
          </td>
          <td>
            Differentiation via advanced AXON AI and integrated solutions
          </td>
        </tr>
        <tr>
          <td><strong>Platform Dependency</strong></td>
          <td>
            Changes in Apple/Google policies affecting ad measurement
          </td>
          <td>
            Reduced ad effectiveness and revenue
          </td>
          <td>
            Proactive adjustments and leveraging first-party data
          </td>
        </tr>
        <tr>
          <td><strong>Macroeconomic</strong></td>
          <td>
            Cyclical reductions in ad spend due to economic downturns
          </td>
          <td>
            Slower revenue growth
          </td>
          <td>
            Strong operational leverage and cash flow generation
          </td>
        </tr>
        <tr>
          <td><strong>Technological</strong></td>
          <td>
            Rapid AI innovation required to stay ahead
          </td>
          <td>
            Competitive disadvantage if lagging in innovation
          </td>
          <td>
            Sustained R&amp;D investment and continuous updates to AXON
          </td>
        </tr>
        <tr>
          <td><strong>Regulatory</strong></td>
          <td>
            Changing data privacy laws and antitrust scrutiny
          </td>
          <td>
            Increased compliance costs and operational adjustments
          </td>
          <td>
            Adaptation to new regulations and geographic diversification
          </td>
        </tr>
        <tr>
          <td><strong>Technical/API</strong></td>
          <td>
            API key exposure and data reliability
          </td>
          <td>
            Imprecise or missing data points
          </td>
          <td>
            Improved API error handling and multiple data sources
          </td>
        </tr>
      </tbody>
    </table>

    <h2>11. Conclusion & Investment Considerations</h2>
    <p class="section-intro">
      Final thoughts and key factors for investors.
    </p>
    <h3>Investment Strengths:</h3>
    <ul>
      <li><strong>Market Leadership:</strong> A top position in mobile ad tech and monetization.</li>
      <li><strong>Technological Edge:</strong> Superior AI via the AXON engine.</li>
      <li><strong>Robust Financials:</strong> Strong revenue and margin growth supported by healthy cash flow.</li>
      <li><strong>Growth Potential:</strong> Expanding into new verticals and international markets.</li>
      <li><strong>Disciplined Capital Allocation:</strong> Focused on share repurchases and debt management.</li>
    </ul>
    <h3>Investment Concerns:</h3>
    <ul>
      <li>
        <strong>Competitive Pressure:</strong> Intense rivalry from major players.
      </li>
      <li>
        <strong>Platform Risks:</strong> Exposure to shifts in mobile ecosystem policies.
      </li>
      <li>
        <strong>Valuation Expectations:</strong> High growth assumptions embedded in current pricing.
      </li>
      <li>
        <strong>Sector Cyclicality:</strong> Vulnerability to economic downturns impacting ad spend.
      </li>
      <li>
        <strong>Technological Obsolescence:</strong> Continuous innovation required in a fast-evolving field.
      </li>
    </ul>
    <p>
      AppLovin presents an interesting investment case driven by its AI-powered platform,
      market leadership, and strong financial performance. Investors should weigh the
      growth potential against competitive and regulatory risks.
    </p>
  </div>

  <script>
    /*
     * Financial Modeling Prep (FMP) API Integration
     * Documentation: https://site.financialmodelingprep.com/developer/docs/stable
     * Demo API Key: hQC5T9ehWTI6XB0kQ6enPU5YslmIa5wN
     */

    document.addEventListener("DOMContentLoaded", () => {
      const apiKey = "hQC5T9ehWTI6XB0kQ6enPU5YslmIa5wN";
      const ticker = "APP";
      const fmpBaseUrl = "https://financialmodelingprep.com/api/v3";

      const fetchedData = {
        quote: null,
        balanceSheet: null,
        incomeStatementAnnual: null,
        incomeStatementTTM: null, // Holds computed TTM EBITDA
        ratios: null,
        keyMetrics: null,
      };

      // --- Helper Functions ---
      const formatNumber = (num, decimals = 2) => {
        if (num === null || num === undefined || isNaN(num)) return "N/A";
        if (Math.abs(num) >= 1e12) return `$${(num / 1e12).toFixed(decimals)}T`;
        if (Math.abs(num) >= 1e9) return `$${(num / 1e9).toFixed(decimals)}B`;
        if (Math.abs(num) >= 1e6) return `$${(num / 1e6).toFixed(decimals)}M`;
        return `$${num.toLocaleString("en-US", {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals,
        })}`;
      };

      const formatRatio = (num, suffix = "x") => {
        if (num === null || num === undefined || isNaN(num) || !isFinite(num))
          return "N/A";
        return `${num.toFixed(2)}${suffix}`;
      };

      const updateElement = (id, value, formatter = null) => {
        const element = document.getElementById(id);
        if (element) {
          let displayValue = "N/A";
          if (value !== null && value !== undefined) {
            displayValue = formatter ? formatter(value) : value;
          }
          const spinner = element.querySelector(".loading-spinner");
          if (spinner) spinner.remove();
          element.textContent = displayValue;
          element.classList.remove("data-placeholder", "error-message", "success-message");
          if (displayValue === "N/A") {
            element.classList.add("error-message");
          } else if (typeof value === "number" && value > 0) {
            // Add success class for positive numbers, adjust if needed
            // element.classList.add("success-message");
          }
        }
      };

      // --- API Fetch Function ---
      // Handles potential array responses for single-record endpoints
      const fetchData = async (url, description, expectSingleRecord = false) => {
        try {
          console.log(`Fetching ${description} from: ${url}`);
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status} for ${description}`);
          }
          const data = await response.json();
          if (!data || (Array.isArray(data) && data.length === 0)) {
            console.warn(`No data received for ${description}`);
            return null;
          }
          console.log(`Successfully fetched ${description}`);
          // If we expect a single record and get an array, return the first element
          if (expectSingleRecord && Array.isArray(data)) {
            return data.length > 0 ? data[0] : null;
          }
          // Otherwise, return the data as is (could be object or array)
          return data;
        } catch (error) {
          console.error(`Error fetching ${description}:`, error);
          return null;
        }
      };

      // --- Specific Data Fetchers ---
      const fetchQuoteData = async () => {
        const url = `${fmpBaseUrl}/quote/${ticker}?apikey=${apiKey}`;
        // Quote endpoint usually returns an array with one object
        fetchedData.quote = await fetchData(url, "Quote Data", true);
      };

      const fetchBalanceSheetData = async () => {
        const url = `${fmpBaseUrl}/balance-sheet-statement/${ticker}?limit=1&apikey=${apiKey}`;
        // Balance sheet with limit=1 returns an array with one object
        fetchedData.balanceSheet = await fetchData(url, "Annual Balance Sheet", true);
      };

      const fetchIncomeStatementAnnualData = async () => {
        const url = `${fmpBaseUrl}/income-statement/${ticker}?limit=1&apikey=${apiKey}`;
        // Income statement with limit=1 returns an array with one object
        fetchedData.incomeStatementAnnual = await fetchData(url, "Annual Income Statement", true);
      };

      const fetchIncomeStatementTTMData = async () => {
        const url = `${fmpBaseUrl}/income-statement/${ticker}?period=quarter&limit=4&apikey=${apiKey}`;
        // Quarterly income statements return an array of objects
        const quarterlyData = await fetchData(url, "Quarterly Income Statements", false);
        if (quarterlyData && Array.isArray(quarterlyData) && quarterlyData.length > 0) {
          const ttmEbitda = quarterlyData.reduce(
            (accum, cur) => accum + (cur.ebitda || 0),
            0
          );
          // Store computed TTM EBITDA in a simple object structure
          fetchedData.incomeStatementTTM = { ebitdaTTM: ttmEbitda };
          console.log("Computed TTM EBITDA:", ttmEbitda);
        } else {
          fetchedData.incomeStatementTTM = null;
          console.warn("Could not compute TTM EBITDA from quarterly data.");
        }
      };

      const fetchRatiosData = async () => {
        const url = `${fmpBaseUrl}/ratios/${ticker}?limit=1&apikey=${apiKey}`;
        // Ratios with limit=1 returns an array with one object
        fetchedData.ratios = await fetchData(url, "Financial Ratios", true);
      };

      const fetchKeyMetricsData = async () => {
        const url = `${fmpBaseUrl}/key-metrics/${ticker}?limit=1&apikey=${apiKey}`;
        // Key metrics with limit=1 returns an array with one object
        fetchedData.keyMetrics = await fetchData(url, "Key Metrics", true);
      };

      // --- Update UI Functions ---
      const updateQuoteUI = () => {
        const quote = fetchedData.quote;
        if (!quote) {
          console.error("Quote data is missing for UI update.");
          return;
        }
        updateElement("current-price", quote.price, (p) => formatNumber(p, 2));
        updateElement("current-price-ref", quote.price, (p) => formatNumber(p, 2));
        updateElement("market-cap", quote.marketCap, (m) => formatNumber(m, 0));
        updateElement("52wk-low", quote.yearLow, (p) => formatNumber(p, 2));
        updateElement("52wk-high", quote.yearHigh, (p) => formatNumber(p, 2));
        updateElement(
          "52wk-range",
          { low: quote.yearLow, high: quote.yearHigh },
          (range) => `${formatNumber(range.low, 2)} - ${formatNumber(range.high, 2)}`
        );
        updateElement("eps-ttm", quote.eps, (e) => formatNumber(e, 2));
        updateElement("pe-ratio", quote.pe, formatRatio);
      };

      const updateFinancialsUI = () => {
        const bs = fetchedData.balanceSheet; // Now expected to be an object
        const isAnnual = fetchedData.incomeStatementAnnual; // Now expected to be an object
        const isTTM = fetchedData.incomeStatementTTM; // Object containing { ebitdaTTM: ... }
        const ratios = fetchedData.ratios; // Now expected to be an object

        if (bs) {
          updateElement("total-debt", bs.totalDebt, (d) => formatNumber(d, 0));
          updateElement("cash-equivalents", bs.cashAndCashEquivalents, (c) => formatNumber(c, 0));
          // Ensure properties exist before calculating current ratio
          if (bs.totalCurrentAssets && bs.totalCurrentLiabilities && bs.totalCurrentLiabilities !== 0) {
            updateElement("current-ratio", bs.totalCurrentAssets / bs.totalCurrentLiabilities, formatRatio);
          } else {
            updateElement("current-ratio", null); // Set to N/A if data missing or denominator is zero
          }
        } else {
          console.error("Balance sheet data missing for UI update.");
        }

        if (isAnnual) {
          updateElement("latest-revenue", isAnnual.revenue, (r) => formatNumber(r, 0));
          updateElement("latest-ebitda", isAnnual.ebitda, (e) => formatNumber(e, 0));
        } else {
          console.error("Annual income statement data missing for UI update.");
        }

        if (isTTM) {
          updateElement("ltm-ebitda", isTTM.ebitdaTTM, (e) => formatNumber(e, 0));
        } else {
          console.error("TTM income statement data (computed) missing for UI update.");
          updateElement("ltm-ebitda", null); // Explicitly set to N/A if calculation failed
        }

        if (ratios) {
          updateElement("peg-ratio", ratios.pegRatio, formatRatio);
        } else {
          console.error("Ratios data missing for UI update.");
        }
        // Interest coverage calculation would need TTM EBIT and Interest Expense,
        // which aren't directly computed in the current TTM logic.
        updateElement("interest-coverage", null); // Set to N/A for now
      };

      const calculateAndUpdateDerivedMetrics = () => {
        const quote = fetchedData.quote; // Object
        const bs = fetchedData.balanceSheet; // Object
        const isAnnual = fetchedData.incomeStatementAnnual; // Object
        const isTTM = fetchedData.incomeStatementTTM; // Object { ebitdaTTM: ... }

        // Ensure required base data exists
        if (!quote || !bs) {
          console.error("Cannot calculate derived metrics: Quote or Balance Sheet data missing.");
          updateElement("net-debt", null);
          updateElement("enterprise-value", null);
          updateElement("ev-revenue-multiple", null);
          updateElement("ev-ebitda-multiple", null);
          updateElement("leverage-ratio", null);
          return;
        }

        const marketCap = quote.marketCap;
        const totalDebt = bs.totalDebt;
        const cash = bs.cashAndCashEquivalents;
        const revenueAnnual = isAnnual?.revenue; // Use optional chaining for safety
        const ebitdaAnnual = isAnnual?.ebitda; // Use optional chaining
        const ebitdaTTM = isTTM?.ebitdaTTM; // Use optional chaining

        let netDebt = null;
        if (totalDebt !== null && totalDebt !== undefined && cash !== null && cash !== undefined) {
          netDebt = totalDebt - cash;
          updateElement("net-debt", netDebt, (n) => formatNumber(n, 0));
        } else {
          updateElement("net-debt", null);
        }

        let enterpriseValue = null;
        if (marketCap !== null && marketCap !== undefined && netDebt !== null) {
          enterpriseValue = marketCap + netDebt;
          updateElement("enterprise-value", enterpriseValue, (ev) => formatNumber(ev, 0));
        } else {
          updateElement("enterprise-value", null);
        }

        // Calculate EV / Revenue
        if (enterpriseValue !== null && revenueAnnual && revenueAnnual !== 0) {
          updateElement("ev-revenue-multiple", enterpriseValue / revenueAnnual, formatRatio);
        } else {
          updateElement("ev-revenue-multiple", null);
        }

        // Calculate EV / EBITDA (Annual)
        if (enterpriseValue !== null && ebitdaAnnual && ebitdaAnnual !== 0) {
          updateElement("ev-ebitda-multiple", enterpriseValue / ebitdaAnnual, formatRatio);
        } else {
          updateElement("ev-ebitda-multiple", null);
        }

        // Calculate Leverage Ratio (Net Debt / LTM EBITDA)
        if (netDebt !== null && ebitdaTTM && ebitdaTTM !== 0) {
          updateElement("leverage-ratio", netDebt / ebitdaTTM, formatRatio);
        } else {
          updateElement("leverage-ratio", null);
        }
      };

      // --- Main Execution ---
      const loadAllDataAndUpdateUI = async () => {
        console.log("Starting data fetch process...");
        try {
          await Promise.all([
            fetchQuoteData(),
            fetchBalanceSheetData(),
            fetchIncomeStatementAnnualData(),
            fetchIncomeStatementTTMData(), // Computes TTM EBITDA
            fetchRatiosData(),
            fetchKeyMetricsData(),
          ]);

          console.log("All data fetched, updating UI...");
          // Update UI sections sequentially after all data is fetched
          updateQuoteUI();
          updateFinancialsUI(); // Depends on BS, IS Annual, IS TTM, Ratios
          calculateAndUpdateDerivedMetrics(); // Depends on Quote, BS, IS Annual, IS TTM

          console.log("UI update complete.");
        } catch (error) {
          console.error("Error during data loading and UI update:", error);
          // Display a general error message if the process fails
          document.querySelectorAll(".data-placeholder").forEach((element) => {
            if (!element.textContent || element.textContent.startsWith("Loading")) {
              element.textContent = "Error";
              element.classList.remove("data-placeholder");
              element.classList.add("error-message");
              const spinner = element.querySelector(".loading-spinner");
              if (spinner) spinner.remove();
            }
          });
        }
      };

      loadAllDataAndUpdateUI();
    });
  </script>
</body>
</html>
